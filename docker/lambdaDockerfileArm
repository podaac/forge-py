#ARG FUNCTION_DIR="/function"

FROM public.ecr.aws/lambda/python:3.11-arm64

# Include global arg in this stage of the build
ARG SOURCE
ARG DIST_PATH

RUN amazon-linux-extras enable gcc11
RUN yum -y install gcc11 gcc11-c++

# Set gcc/g++ to point to gcc11
RUN alternatives --install /usr/bin/gcc gcc /usr/bin/gcc11 100 \
    && alternatives --install /usr/bin/g++ g++ /usr/bin/g++11 100

# Create function directory
# RUN mkdir -p ${FUNCTION_DIR}
# WORKDIR ${FUNCTION_DIR}

# Install forge-py from artifactory
COPY $DIST_PATH $DIST_PATH

# install forge-py into working directory so we can call lambda
RUN pip3 install awslambdaric --target $LAMBDA_TASK_ROOT

RUN pip3 install --no-cache-dir --force --index-url https://pypi.org/simple/ --extra-index-url https://test.pypi.org/simple/ --target "${LAMBDA_TASK_ROOT}" $SOURCE

RUN rm -rf $DIST_PATH

ENTRYPOINT []
CMD ["podaac.lambda_handler.lambda_handler.handler"]